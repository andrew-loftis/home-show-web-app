rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() { 
      return request.auth != null && request.auth.uid != null; 
    }
    
    function isOwner(uid) { 
      return isSignedIn() && request.auth.uid == uid; 
    }
    
    // Admin check - checks both adminEmails collection and user role
    function isAdmin() {
      return isSignedIn() && (
        exists(/databases/$(database)/documents/adminEmails/$(request.auth.token.email)) ||
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
      );
    }

    // Admin registry - emails that have admin access
    match /adminEmails/{emailId} {
      allow read, create, update, delete: if isAdmin();
    }

    // Users collection - for user profiles and role management
    match /users/{uid} {
      allow read: if isOwner(uid) || isAdmin();
      allow create: if isOwner(uid) || isAdmin();
      // Users can update their own profile but admins can change roles
      allow update: if (
        isOwner(uid) && (
          !("role" in request.resource.data) || 
          request.resource.data.role == resource.data.role
        )
      ) || isAdmin();
      allow delete: if isOwner(uid) || isAdmin();
    }

    // Vendors collection - vendor registrations and profiles
    match /vendors/{vendorId} {
      // Anyone can read approved vendors; owners and admins can read their own/all
      allow read: if resource.data.approved == true || 
                  (isSignedIn() && (
                    resource.data.ownerUid == request.auth.uid || isAdmin()
                  ));
      allow create: if isSignedIn() && (
        request.resource.data.ownerUid == request.auth.uid || isAdmin()
      );
      allow update, delete: if isSignedIn() && (
        resource.data.ownerUid == request.auth.uid || isAdmin()
      );
    }

    // Attendees collection - attendee profiles
    match /attendees/{attendeeId} {
      // Owners can read their own; admins can read all for management
      allow read: if isSignedIn() && (
        resource.data.ownerUid == request.auth.uid || isAdmin()
      );
      allow create: if isSignedIn() && (
        request.resource.data.ownerUid == request.auth.uid || isAdmin()
      );
      allow update, delete: if isSignedIn() && (
        resource.data.ownerUid == request.auth.uid || isAdmin()
      );
    }

    // Leads collection - connections between attendees and vendors
    match /leads/{leadId} {
      allow read: if isSignedIn() && (
        (
          exists(/databases/$(database)/documents/attendees/$(resource.data.attendeeId)) &&
          get(/databases/$(database)/documents/attendees/$(resource.data.attendeeId)).data.ownerUid == request.auth.uid
        ) || (
          exists(/databases/$(database)/documents/vendors/$(resource.data.vendorId)) &&
          get(/databases/$(database)/documents/vendors/$(resource.data.vendorId)).data.ownerUid == request.auth.uid
        ) || isAdmin()
      );
      allow create, update: if isSignedIn() && (
        request.resource.data.createdByUid == request.auth.uid && (
          (exists(/databases/$(database)/documents/attendees/$(request.resource.data.attendeeId)) &&
           get(/databases/$(database)/documents/attendees/$(request.resource.data.attendeeId)).data.ownerUid == request.auth.uid) ||
          (exists(/databases/$(database)/documents/vendors/$(request.resource.data.vendorId)) &&
           get(/databases/$(database)/documents/vendors/$(request.resource.data.vendorId)).data.ownerUid == request.auth.uid)
        )
      ) || isAdmin();
      allow delete: if isAdmin() || (
        isSignedIn() && resource.data.createdByUid == request.auth.uid
      );
    }

    // Booth layout collection - admin managed booth inventory
    match /boothLayout/{boothId} {
      allow read: if isSignedIn(); // All users can see booth layout
      allow create, update, delete: if isAdmin(); // Only admins can manage booths
    }

    // Legacy booths collection - for compatibility
    match /booths/{boothId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    // Public content - event information, categories
    match /public/{docId} {
      allow read: if true; // Public read access
      allow write: if isAdmin(); // Only admins can update public content
    }

    // User notifications
    match /notifications/{notificationId} {
      allow read: if isAdmin() || (
        isSignedIn() && resource.data.userId == request.auth.uid
      );
      allow create: if isAdmin();
      allow update: if isAdmin() || (
        isSignedIn() && 
        resource.data.userId == request.auth.uid &&
        request.resource.data.userId == resource.data.userId
      );
      allow delete: if isAdmin() || (
        isSignedIn() && resource.data.userId == request.auth.uid
      );
    }

    // Default deny all other collections
    match /{document=**} { 
      allow read, write: if false; 
    }
  }
}