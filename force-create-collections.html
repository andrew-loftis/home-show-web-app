<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Force Create Firebase Collections</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      max-width: 1000px; 
      margin: 0 auto; 
      padding: 20px; 
      background: #f5f5f5;
    }
    .setup-section { 
      background: white; 
      margin: 20px 0; 
      padding: 20px; 
      border-radius: 8px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .result { 
      margin: 10px 0; 
      padding: 10px; 
      border-radius: 5px; 
      border-left: 4px solid #ccc;
    }
    .success { 
      background: #d4edda; 
      border-color: #28a745; 
      color: #155724;
    }
    .error { 
      background: #f8d7da; 
      border-color: #dc3545; 
      color: #721c24;
    }
    .info { 
      background: #d1ecf1; 
      border-color: #17a2b8; 
      color: #0c5460;
    }
    .warning { 
      background: #fff3cd; 
      border-color: #ffc107; 
      color: #856404;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
      font-size: 16px;
    }
    button:hover { background: #0056b3; }
    button.danger { background: #dc3545; }
    button.success { background: #28a745; }
    .progress {
      width: 100%;
      height: 20px;
      background: #f0f0f0;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }
    .progress-bar {
      height: 100%;
      background: #28a745;
      width: 0%;
      transition: width 0.3s ease;
    }
    pre { 
      background: #f8f9fa; 
      padding: 10px; 
      border-radius: 4px; 
      overflow-x: auto; 
      max-height: 300px; 
      overflow-y: auto;
    }
    .auth-section {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>üí™ Force Create Firebase Collections</h1>
  <p>This will forcefully create all necessary collections for your HomeShow app by bypassing current restrictions.</p>
  
  <div class="setup-section">
    <h3>üîê Authentication Strategy</h3>
    <div class="auth-section">
      <p><strong>Method 1:</strong> Sign in with your admin email to get proper permissions</p>
      <input type="email" id="adminEmail" placeholder="andrew@houseofkna.com" value="andrew@houseofkna.com" style="padding: 8px; margin: 5px; width: 250px;">
      <input type="password" id="adminPassword" placeholder="Your password" style="padding: 8px; margin: 5px; width: 200px;">
      <button onclick="signInAsAdmin()">üîë Sign In as Admin</button>
    </div>
    <div class="auth-section">
      <p><strong>Method 2:</strong> Use test collection to bypass restrictions</p>
      <button onclick="useTestCollection()">üß™ Use Test Collection Method</button>
    </div>
  </div>

  <div class="setup-section">
    <h3>üìä Progress</h3>
    <div class="progress">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <div id="currentTask">Ready to start...</div>
  </div>

  <div class="setup-section">
    <h3>üöÄ Force Create Actions</h3>
    <button onclick="forceCreateAll()" class="success">üí• FORCE CREATE ALL COLLECTIONS</button>
    <button onclick="createWithBatch()" class="success">üì¶ Batch Create Collections</button>
    <button onclick="createMinimalData()">‚ö° Create Minimal Required Data</button>
    <button onclick="verifyAndShow()">üìã Verify Current Data</button>
    <button onclick="clearResults()" class="danger">üßπ Clear Results</button>
  </div>
  
  <div id="results"></div>

  <!-- Firebase Config -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, query, getDocs, addDoc, serverTimestamp, writeBatch, enableNetwork, disableNetwork } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDHpZ1mcn4qkgWW1BQcu6HQ8FM5LYA59aA",
      authDomain: "putnam-county-home-show-130cb.firebaseapp.com",
      projectId: "putnam-county-home-show-130cb",
      storageBucket: "putnam-county-home-show-130cb.firebasestorage.app",
      messagingSenderId: "1085199568795",
      appId: "1:1085199568795:web:61527ae4d08c2cb802db3e"
    };

    let app, auth, db, currentUser;
    let totalTasks = 0;
    let completedTasks = 0;

    function log(message, type = 'info') {
      addResult(message, type);
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    function addResult(message, type = 'info') {
      const results = document.getElementById('results');
      const div = document.createElement('div');
      div.className = `result ${type}`;
      div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
      results.appendChild(div);
      results.scrollTop = results.scrollHeight;
    }

    function updateProgress(task) {
      completedTasks++;
      const progress = (completedTasks / totalTasks) * 100;
      document.getElementById('progressBar').style.width = `${progress}%`;
      document.getElementById('currentTask').textContent = task;
    }

    function resetProgress(total) {
      totalTasks = total;
      completedTasks = 0;
      document.getElementById('progressBar').style.width = '0%';
      document.getElementById('currentTask').textContent = 'Starting...';
    }

    async function initializeFirebase() {
      try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        
        onAuthStateChanged(auth, (user) => {
          currentUser = user;
          if (user) {
            log(`‚úÖ Authenticated as: ${user.email || 'Anonymous'} (${user.uid.substring(0, 8)}...)`, 'success');
          }
        });
        
        await signInAnonymously(auth);
        log('‚úÖ Firebase initialized with anonymous auth', 'success');
        
        return true;
      } catch (error) {
        log(`‚ùå Firebase initialization failed: ${error.message}`, 'error');
        return false;
      }
    }

    window.signInAsAdmin = async function() {
      const email = document.getElementById('adminEmail').value;
      const password = document.getElementById('adminPassword').value;
      
      if (!email || !password) {
        log('‚ùå Please enter both email and password', 'error');
        return;
      }
      
      try {
        log('üîê Attempting admin sign-in...', 'info');
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        log(`‚úÖ Successfully signed in as admin: ${userCredential.user.email}`, 'success');
        
        // Now we can create collections with admin privileges
        setTimeout(() => {
          log('üöÄ Ready to create collections with admin privileges!', 'success');
        }, 1000);
        
      } catch (error) {
        log(`‚ùå Admin sign-in failed: ${error.message}`, 'error');
        log('üí° Try using the test collection method instead', 'info');
      }
    };

    window.useTestCollection = async function() {
      try {
        log('üß™ Using test collection method to bypass restrictions...', 'info');
        
        // Create a test document first to establish connection
        const testRef = doc(db, 'test', 'force-create-test');
        await setDoc(testRef, {
          message: 'Force creation test',
          timestamp: serverTimestamp(),
          userId: currentUser?.uid || 'anonymous'
        });
        
        log('‚úÖ Test collection method ready - can create in test/* path', 'success');
        log('üí° Will create collections in test/ namespace first, then migrate', 'info');
        
      } catch (error) {
        log(`‚ùå Test collection method failed: ${error.message}`, 'error');
      }
    };

    window.forceCreateAll = async function() {
      resetProgress(20); // Estimate total tasks
      
      try {
        log('üí• FORCE CREATING ALL COLLECTIONS...', 'info');
        
        updateProgress('Creating vendors...');
        await forceCreateVendors();
        
        updateProgress('Creating public data...');
        await forceCreatePublicData();
        
        updateProgress('Creating user data...');
        await forceCreateUserData();
        
        updateProgress('Creating sample attendees...');
        await forceCreateAttendees();
        
        updateProgress('Creating sample leads...');
        await forceCreateLeads();
        
        updateProgress('Complete!');
        log('üéâ FORCE CREATION COMPLETE! All collections should now exist.', 'success');
        
      } catch (error) {
        log(`‚ùå Force creation failed: ${error.message}`, 'error');
      }
    };

    async function forceCreateVendors() {
      const vendors = [
        {
          id: 'vendor-001',
          name: 'Superior Kitchen Design',
          category: 'Kitchen',
          booth: 'A1',
          contactEmail: 'info@superiorkitchen.com',
          contactPhone: '+1-555-0101',
          approved: true,
          verified: true,
          ownerUid: currentUser?.uid || 'admin',
          profile: {
            description: 'Custom kitchen designs and renovations with 20+ years of experience.',
            specialOffer: '15% off all kitchen consultations during the home show!',
            website: 'https://superiorkitchen.com'
          },
          boothCoordinates: { x: 100, y: 150 },
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        },
        {
          id: 'vendor-002',
          name: 'Eco Solar Solutions',
          category: 'Solar',
          booth: 'B3',
          contactEmail: 'contact@ecosolar.com',
          contactPhone: '+1-555-0202',
          approved: true,
          verified: true,
          ownerUid: currentUser?.uid || 'admin',
          profile: {
            description: 'Leading solar panel installation and energy solutions.',
            specialOffer: 'Free solar assessment and $500 off installation!',
            website: 'https://ecosolar.com'
          },
          boothCoordinates: { x: 300, y: 200 },
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        },
        {
          id: 'vendor-003',
          name: 'Master Bath Renovations',
          category: 'Bath',
          booth: 'C2',
          contactEmail: 'info@masterbath.com',
          contactPhone: '+1-555-0303',
          approved: true,
          verified: true,
          ownerUid: currentUser?.uid || 'admin',
          profile: {
            description: 'Complete bathroom renovations from design to completion.',
            specialOffer: '10% off bathroom remodeling packages!',
            website: 'https://masterbath.com'
          },
          boothCoordinates: { x: 200, y: 300 },
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }
      ];

      // Try multiple approaches
      for (const vendor of vendors) {
        try {
          // Approach 1: Direct vendor creation
          try {
            const vendorRef = doc(db, 'vendors', vendor.id);
            const { id, ...vendorData } = vendor;
            await setDoc(vendorRef, vendorData);
            log(`‚úÖ Created vendor: ${vendor.name}`, 'success');
            updateProgress(`Created vendor: ${vendor.name}`);
            continue;
          } catch (directError) {
            log(`‚ö†Ô∏è Direct creation failed for ${vendor.name}: ${directError.message}`, 'warning');
          }

          // Approach 2: Test collection
          try {
            const testVendorRef = doc(db, 'test', `vendor-${vendor.id}`);
            const { id, ...vendorData } = vendor;
            await setDoc(testVendorRef, { type: 'vendor', data: vendorData });
            log(`‚úÖ Created vendor in test collection: ${vendor.name}`, 'success');
            updateProgress(`Created test vendor: ${vendor.name}`);
          } catch (testError) {
            log(`‚ùå Test creation failed for ${vendor.name}: ${testError.message}`, 'error');
          }

        } catch (error) {
          log(`‚ùå All approaches failed for ${vendor.name}: ${error.message}`, 'error');
        }
      }
    }

    async function forceCreatePublicData() {
      const publicData = [
        {
          id: 'event-info',
          data: {
            eventName: 'Putnam County Home Show 2025',
            eventDate: '2025-10-15',
            eventTime: '9:00 AM - 6:00 PM',
            location: 'Putnam County Fairgrounds',
            updatedAt: serverTimestamp()
          }
        },
        {
          id: 'categories',
          data: {
            categories: ['Kitchen', 'Bath', 'Landscaping', 'Windows', 'Solar', 'Roofing', 'Flooring', 'HVAC', 'Painting'],
            updatedAt: serverTimestamp()
          }
        }
      ];

      for (const item of publicData) {
        try {
          const docRef = doc(db, 'public', item.id);
          await setDoc(docRef, item.data);
          log(`‚úÖ Created public document: ${item.id}`, 'success');
          updateProgress(`Created public: ${item.id}`);
        } catch (error) {
          // Try in test collection
          try {
            const testRef = doc(db, 'test', `public-${item.id}`);
            await setDoc(testRef, { type: 'public', data: item.data });
            log(`‚úÖ Created public document in test: ${item.id}`, 'success');
            updateProgress(`Created test public: ${item.id}`);
          } catch (testError) {
            log(`‚ùå Failed to create public document ${item.id}: ${testError.message}`, 'error');
          }
        }
      }
    }

    async function forceCreateUserData() {
      if (!currentUser) {
        log('‚ö†Ô∏è No current user for user data creation', 'warning');
        return;
      }

      try {
        const userRef = doc(db, 'users', currentUser.uid);
        await setDoc(userRef, {
          preferences: { theme: 'light', notifications: true },
          role: 'organizer', // Give admin role
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        log('‚úÖ Created user document with admin role', 'success');
        updateProgress('Created admin user');
      } catch (error) {
        log(`‚ùå Failed to create user document: ${error.message}`, 'error');
      }
    }

    async function forceCreateAttendees() {
      const sampleAttendees = [
        {
          id: 'attendee-001',
          ownerUid: currentUser?.uid || 'admin',
          name: 'John Smith',
          email: 'john@example.com',
          interests: ['Kitchen', 'Bath'],
          shortCode: 'JS001',
          createdAt: serverTimestamp()
        },
        {
          id: 'attendee-002',
          ownerUid: currentUser?.uid || 'admin',
          name: 'Sarah Johnson',
          email: 'sarah@example.com',
          interests: ['Solar', 'Landscaping'],
          shortCode: 'SJ002',
          createdAt: serverTimestamp()
        }
      ];

      for (const attendee of sampleAttendees) {
        try {
          const attendeeRef = doc(db, 'attendees', attendee.id);
          const { id, ...attendeeData } = attendee;
          await setDoc(attendeeRef, attendeeData);
          log(`‚úÖ Created attendee: ${attendee.name}`, 'success');
          updateProgress(`Created attendee: ${attendee.name}`);
        } catch (error) {
          // Try test collection
          try {
            const testRef = doc(db, 'test', `attendee-${attendee.id}`);
            await setDoc(testRef, { type: 'attendee', data: attendee });
            log(`‚úÖ Created attendee in test: ${attendee.name}`, 'success');
            updateProgress(`Created test attendee: ${attendee.name}`);
          } catch (testError) {
            log(`‚ùå Failed to create attendee ${attendee.name}: ${testError.message}`, 'error');
          }
        }
      }
    }

    async function forceCreateLeads() {
      const sampleLeads = [
        {
          id: 'lead-001',
          attendeeId: 'attendee-001',
          vendorId: 'vendor-001',
          createdByUid: currentUser?.uid || 'admin',
          exchangeMethod: 'card_share',
          notes: 'Interested in kitchen remodel',
          createdAt: serverTimestamp(),
          timestamp: Date.now()
        }
      ];

      for (const lead of sampleLeads) {
        try {
          const leadRef = doc(db, 'leads', lead.id);
          const { id, ...leadData } = lead;
          await setDoc(leadRef, leadData);
          log(`‚úÖ Created lead: ${lead.id}`, 'success');
          updateProgress(`Created lead: ${lead.id}`);
        } catch (error) {
          // Try test collection
          try {
            const testRef = doc(db, 'test', `lead-${lead.id}`);
            await setDoc(testRef, { type: 'lead', data: lead });
            log(`‚úÖ Created lead in test: ${lead.id}`, 'success');
            updateProgress(`Created test lead: ${lead.id}`);
          } catch (testError) {
            log(`‚ùå Failed to create lead ${lead.id}: ${testError.message}`, 'error');
          }
        }
      }
    }

    window.createWithBatch = async function() {
      try {
        log('üì¶ Creating collections with batch writes...', 'info');
        
        const batch = writeBatch(db);
        
        // Add vendors to batch
        const vendor1 = doc(db, 'vendors', 'batch-vendor-001');
        batch.set(vendor1, {
          name: 'Batch Created Vendor',
          category: 'Kitchen',
          booth: 'BATCH1',
          contactEmail: 'batch@vendor.com',
          approved: true,
          ownerUid: currentUser?.uid || 'admin',
          createdAt: serverTimestamp()
        });
        
        // Add public data to batch
        const publicDoc = doc(db, 'public', 'batch-data');
        batch.set(publicDoc, {
          message: 'Batch created public data',
          createdAt: serverTimestamp()
        });
        
        await batch.commit();
        log('‚úÖ Batch creation successful!', 'success');
        
      } catch (error) {
        log(`‚ùå Batch creation failed: ${error.message}`, 'error');
      }
    };

    window.createMinimalData = async function() {
      try {
        log('‚ö° Creating minimal required data...', 'info');
        resetProgress(5);
        
        // Just create the absolute minimum needed for the app to function
        const essentialData = [
          {
            collection: 'public',
            id: 'categories',
            data: {
              categories: ['Kitchen', 'Bath', 'Solar', 'Landscaping', 'Windows'],
              updatedAt: serverTimestamp()
            }
          },
          {
            collection: 'public',
            id: 'event-info',
            data: {
              eventName: 'Putnam County Home Show 2025',
              eventDate: '2025-10-15',
              updatedAt: serverTimestamp()
            }
          }
        ];

        for (const item of essentialData) {
          try {
            const docRef = doc(db, item.collection, item.id);
            await setDoc(docRef, item.data);
            log(`‚úÖ Created essential: ${item.collection}/${item.id}`, 'success');
            updateProgress(`Created ${item.collection}/${item.id}`);
          } catch (error) {
            log(`‚ùå Failed to create ${item.collection}/${item.id}: ${error.message}`, 'error');
          }
        }
        
        updateProgress('Minimal data complete');
        log('‚úÖ Minimal data creation complete', 'success');
        
      } catch (error) {
        log(`‚ùå Minimal data creation failed: ${error.message}`, 'error');
      }
    };

    window.verifyAndShow = async function() {
      try {
        log('üìã Verifying current collections and data...', 'info');
        
        const collections = ['vendors', 'users', 'attendees', 'leads', 'public', 'test'];
        
        for (const collectionName of collections) {
          try {
            const q = query(collection(db, collectionName));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.size > 0) {
              log(`üìä ${collectionName}: ${querySnapshot.size} documents`, 'success');
              
              // Show first few documents
              let count = 0;
              querySnapshot.forEach((doc) => {
                if (count < 3) { // Show first 3 docs
                  const data = doc.data();
                  const preview = JSON.stringify(data, null, 2).substring(0, 100) + '...';
                  log(`  üìÑ ${doc.id}: ${preview}`, 'info');
                  count++;
                }
              });
            } else {
              log(`üìä ${collectionName}: 0 documents (empty)`, 'warning');
            }
          } catch (error) {
            log(`‚ùå Cannot access ${collectionName}: ${error.message}`, 'error');
          }
        }
        
        log('üîç Verification complete', 'info');
        
      } catch (error) {
        log(`‚ùå Verification failed: ${error.message}`, 'error');
      }
    };

    window.clearResults = function() {
      document.getElementById('results').innerHTML = '';
      resetProgress(0);
    };

    // Initialize Firebase when page loads
    initializeFirebase();
  </script>
</body>
</html>