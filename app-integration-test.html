<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HomeShow App Integration Test</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      max-width: 1000px; 
      margin: 0 auto; 
      padding: 20px; 
      background: #f5f5f5;
    }
    .test-section { 
      background: white; 
      margin: 20px 0; 
      padding: 20px; 
      border-radius: 8px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-result { 
      margin: 10px 0; 
      padding: 10px; 
      border-radius: 5px; 
      border-left: 4px solid #ccc;
    }
    .success { 
      background: #d4edda; 
      border-color: #28a745; 
      color: #155724;
    }
    .error { 
      background: #f8d7da; 
      border-color: #dc3545; 
      color: #721c24;
    }
    .info { 
      background: #d1ecf1; 
      border-color: #17a2b8; 
      color: #0c5460;
    }
    .warning { 
      background: #fff3cd; 
      border-color: #ffc107; 
      color: #856404;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background: #0056b3; }
    button:disabled { background: #6c757d; cursor: not-allowed; }
    .step { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; }
    .user-info { background: #e3f2fd; padding: 10px; border-radius: 4px; margin: 10px 0; }
  </style>
</head>
<body>
  <h1>üè† HomeShow App Integration Test</h1>
  <p>Testing your app's integration with Firestore using the updated security rules.</p>
  
  <div class="user-info" id="userInfo">
    <strong>Current User:</strong> <span id="userStatus">Not authenticated</span>
  </div>

  <div class="test-section">
    <h3>üìã Test Flow</h3>
    <button onclick="runFullTest()">üöÄ Run Complete Test Suite</button>
    <button onclick="clearResults()">üßπ Clear Results</button>
    
    <div class="step">
      <strong>Step 1:</strong> Anonymous Authentication
      <button onclick="testAuthentication()">Test Auth</button>
    </div>
    
    <div class="step">
      <strong>Step 2:</strong> Create User Profile
      <button onclick="testUserProfile()">Test User</button>
    </div>
    
    <div class="step">
      <strong>Step 3:</strong> Create Attendee Profile
      <button onclick="testAttendeeProfile()">Test Attendee</button>
    </div>
    
    <div class="step">
      <strong>Step 4:</strong> Read Approved Vendors
      <button onclick="testVendorRead()">Test Vendors</button>
    </div>
    
    <div class="step">
      <strong>Step 5:</strong> Create Lead (Card Exchange)
      <button onclick="testLeadCreation()">Test Leads</button>
    </div>
  </div>
  
  <div id="results"></div>

  <!-- Firebase Config (same as your main app) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, query, getDocs, where, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDHpZ1mcn4qkgWW1BQcu6HQ8FM5LYA59aA",
      authDomain: "putnam-county-home-show-130cb.firebaseapp.com",
      projectId: "putnam-county-home-show-130cb",
      storageBucket: "putnam-county-home-show-130cb.firebasestorage.app",
      messagingSenderId: "1085199568795",
      appId: "1:1085199568795:web:61527ae4d08c2cb802db3e"
    };

    // Initialize Firebase
    let app, auth, db;
    let currentUser = null;
    let testAttendeeId = null;

    function log(message, type = 'info') {
      addResult(message, type);
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    function addResult(message, type = 'info') {
      const results = document.getElementById('results');
      const div = document.createElement('div');
      div.className = `test-result ${type}`;
      div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
      results.appendChild(div);
      results.scrollTop = results.scrollHeight;
    }

    function updateUserStatus() {
      const userStatus = document.getElementById('userStatus');
      if (currentUser) {
        userStatus.textContent = `${currentUser.isAnonymous ? 'Anonymous' : currentUser.email} (${currentUser.uid.substring(0, 8)}...)`;
      } else {
        userStatus.textContent = 'Not authenticated';
      }
    }

    async function initializeFirebase() {
      try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        
        onAuthStateChanged(auth, (user) => {
          currentUser = user;
          updateUserStatus();
        });
        
        log('‚úÖ Firebase initialized successfully', 'success');
        return true;
      } catch (error) {
        log(`‚ùå Firebase initialization failed: ${error.message}`, 'error');
        return false;
      }
    }

    window.testAuthentication = async function() {
      try {
        log('üîê Testing anonymous authentication...', 'info');
        
        const userCredential = await signInAnonymously(auth);
        log(`‚úÖ Anonymous sign-in successful: ${userCredential.user.uid}`, 'success');
        
        return userCredential.user;
      } catch (error) {
        log(`‚ùå Authentication failed: ${error.message}`, 'error');
        throw error;
      }
    };

    window.testUserProfile = async function() {
      try {
        if (!currentUser) {
          log('‚ö†Ô∏è No authenticated user', 'warning');
          return;
        }
        
        log('üë§ Testing user profile creation...', 'info');
        
        const userRef = doc(db, 'users', currentUser.uid);
        const userData = {
          preferences: {
            theme: 'light',
            notifications: true
          },
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };
        
        await setDoc(userRef, userData);
        log('‚úÖ User profile created successfully', 'success');
        
        // Test reading it back
        const userDoc = await getDoc(userRef);
        if (userDoc.exists()) {
          log('‚úÖ User profile read successfully', 'success');
        } else {
          log('‚ö†Ô∏è User profile not found after creation', 'warning');
        }
        
      } catch (error) {
        log(`‚ùå User profile test failed: ${error.message}`, 'error');
        throw error;
      }
    };

    window.testAttendeeProfile = async function() {
      try {
        if (!currentUser) {
          log('‚ö†Ô∏è No authenticated user', 'warning');
          return;
        }
        
        log('üé´ Testing attendee profile creation...', 'info');
        
        testAttendeeId = `test-attendee-${Date.now()}`;
        const attendeeRef = doc(db, 'attendees', testAttendeeId);
        const attendeeData = {
          ownerUid: currentUser.uid,
          name: 'Test Attendee',
          email: 'test@example.com',
          phone: '+1234567890',
          zip: '12345',
          interests: ['Kitchen', 'Bath', 'Solar'],
          shortCode: `TEST${Math.floor(Math.random() * 10000)}`,
          consentEmail: true,
          consentSMS: false,
          savedBusinessCards: [],
          card: {
            bio: 'This is a test attendee profile',
            familySize: 4,
            visitingReasons: ['Kitchen remodel', 'Solar installation'],
            location: 'Test City, ST'
          },
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };
        
        await setDoc(attendeeRef, attendeeData);
        log(`‚úÖ Attendee profile created: ${testAttendeeId}`, 'success');
        
        // Test reading it back
        const attendeeDoc = await getDoc(attendeeRef);
        if (attendeeDoc.exists()) {
          log('‚úÖ Attendee profile read successfully', 'success');
        } else {
          log('‚ö†Ô∏è Attendee profile not found after creation', 'warning');
        }
        
      } catch (error) {
        log(`‚ùå Attendee profile test failed: ${error.message}`, 'error');
        throw error;
      }
    };

    window.testVendorRead = async function() {
      try {
        log('üè™ Testing vendor directory read...', 'info');
        
        const vendorsRef = collection(db, 'vendors');
        const q = query(vendorsRef, where('approved', '==', true));
        const querySnapshot = await getDocs(q);
        
        log(`‚úÖ Vendor query successful: ${querySnapshot.size} approved vendors found`, 'success');
        
        if (querySnapshot.size === 0) {
          log('‚ÑπÔ∏è No approved vendors found - this is normal if none have been created yet', 'info');
        } else {
          querySnapshot.forEach((doc) => {
            const vendor = doc.data();
            log(`üìã Vendor: ${vendor.name} (${vendor.category})`, 'info');
          });
        }
        
      } catch (error) {
        log(`‚ùå Vendor read test failed: ${error.message}`, 'error');
        throw error;
      }
    };

    window.testLeadCreation = async function() {
      try {
        if (!currentUser || !testAttendeeId) {
          log('‚ö†Ô∏è Need authenticated user and attendee profile first', 'warning');
          return;
        }
        
        log('ü§ù Testing lead creation...', 'info');
        
        // Create a test vendor first (this will likely fail due to admin restriction, but let's try)
        const testVendorId = `test-vendor-${Date.now()}`;
        let vendorExists = false;
        
        try {
          const vendorRef = doc(db, 'vendors', testVendorId);
          await setDoc(vendorRef, {
            name: 'Test Vendor',
            category: 'Kitchen',
            booth: 'A1',
            contactEmail: 'vendor@test.com',
            approved: true,
            ownerUid: currentUser.uid,
            createdAt: serverTimestamp()
          });
          vendorExists = true;
          log('‚úÖ Test vendor created successfully', 'success');
        } catch (error) {
          log(`‚ö†Ô∏è Could not create test vendor (expected with admin-only rules): ${error.message}`, 'warning');
          
          // Try to find an existing vendor instead
          const vendorsRef = collection(db, 'vendors');
          const vendorQuery = query(vendorsRef, where('approved', '==', true));
          const vendorSnapshot = await getDocs(vendorQuery);
          
          if (vendorSnapshot.size > 0) {
            const existingVendor = vendorSnapshot.docs[0];
            testVendorId = existingVendor.id;
            vendorExists = true;
            log(`‚ÑπÔ∏è Using existing vendor for test: ${existingVendor.data().name}`, 'info');
          }
        }
        
        if (!vendorExists) {
          log('‚ùå No vendor available for lead test', 'error');
          return;
        }
        
        // Now try to create a lead
        const leadsRef = collection(db, 'leads');
        const leadData = {
          attendeeId: testAttendeeId,
          vendorId: testVendorId,
          createdByUid: currentUser.uid,
          exchangeMethod: 'card_share',
          notes: 'Test lead created via integration test',
          createdAt: serverTimestamp(),
          timestamp: Date.now()
        };
        
        const leadDoc = await addDoc(leadsRef, leadData);
        log(`‚úÖ Lead created successfully: ${leadDoc.id}`, 'success');
        
      } catch (error) {
        log(`‚ùå Lead creation test failed: ${error.message}`, 'error');
        if (error.code) {
          log(`üîç Error code: ${error.code}`, 'error');
        }
      }
    };

    window.runFullTest = async function() {
      log('üöÄ Starting complete test suite...', 'info');
      
      try {
        // Step 1: Authentication
        await testAuthentication();
        await new Promise(resolve => setTimeout(resolve, 1000)); // Wait for auth state
        
        // Step 2: User Profile
        await testUserProfile();
        
        // Step 3: Attendee Profile
        await testAttendeeProfile();
        
        // Step 4: Vendor Read
        await testVendorRead();
        
        // Step 5: Lead Creation
        await testLeadCreation();
        
        log('üéâ Complete test suite finished!', 'success');
        
      } catch (error) {
        log(`‚ùå Test suite failed: ${error.message}`, 'error');
      }
    };

    window.clearResults = function() {
      document.getElementById('results').innerHTML = '';
    };

    // Initialize Firebase when page loads
    initializeFirebase();
  </script>
</body>
</html>