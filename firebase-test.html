<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firebase Connection Test</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      max-width: 800px; 
      margin: 0 auto; 
      padding: 20px; 
      background: #f5f5f5;
    }
    .test-result { 
      margin: 10px 0; 
      padding: 10px; 
      border-radius: 5px; 
      border-left: 4px solid #ccc;
    }
    .success { 
      background: #d4edda; 
      border-color: #28a745; 
      color: #155724;
    }
    .error { 
      background: #f8d7da; 
      border-color: #dc3545; 
      color: #721c24;
    }
    .info { 
      background: #d1ecf1; 
      border-color: #17a2b8; 
      color: #0c5460;
    }
    .warning { 
      background: #fff3cd; 
      border-color: #ffc107; 
      color: #856404;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background: #0056b3; }
    button:disabled { background: #6c757d; cursor: not-allowed; }
    #console { 
      background: #000; 
      color: #00ff00; 
      padding: 10px; 
      border-radius: 5px; 
      height: 200px; 
      overflow-y: auto; 
      font-family: monospace;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>ðŸ”¥ Firebase Connection Test</h1>
  <p>Testing connection to your Firestore database...</p>
  
  <div id="results"></div>
  
  <h3>Test Actions:</h3>
  <button onclick="testAuth()">Test Authentication</button>
  <button onclick="testFirestore()">Test Firestore</button>
  <button onclick="testSecurityRules()">Test Security Rules</button>
  <button onclick="clearResults()">Clear Results</button>
  
  <h3>Console Output:</h3>
  <div id="console"></div>

  <!-- Firebase Config (same as your main app) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, query, getDocs, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    // Use the same config as your main app
    const firebaseConfig = {
      apiKey: "AIzaSyDHpZ1mcn4qkgWW1BQcu6HQ8FM5LYA59aA",
      authDomain: "putnam-county-home-show-130cb.firebaseapp.com",
      projectId: "putnam-county-home-show-130cb",
      storageBucket: "putnam-county-home-show-130cb.firebasestorage.app",
      messagingSenderId: "1085199568795",
      appId: "1:1085199568795:web:61527ae4d08c2cb802db3e"
    };

    // Initialize Firebase
    let app, auth, db;
    let currentUser = null;

    function log(message, type = 'info') {
      const console = document.getElementById('console');
      const timestamp = new Date().toLocaleTimeString();
      console.textContent += `[${timestamp}] ${message}\n`;
      console.scrollTop = console.scrollHeight;
      
      addResult(message, type);
    }

    function addResult(message, type = 'info') {
      const results = document.getElementById('results');
      const div = document.createElement('div');
      div.className = `test-result ${type}`;
      div.textContent = message;
      results.appendChild(div);
    }

    async function initializeFirebase() {
      try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        
        log('âœ… Firebase initialized successfully', 'success');
        
        // Listen for auth state changes
        onAuthStateChanged(auth, (user) => {
          if (user) {
            currentUser = user;
            log(`âœ… User authenticated: ${user.isAnonymous ? 'Anonymous' : user.email}`, 'success');
          } else {
            currentUser = null;
            log('â„¹ï¸ No user authenticated', 'info');
          }
        });
        
        return true;
      } catch (error) {
        log(`âŒ Firebase initialization failed: ${error.message}`, 'error');
        return false;
      }
    }

    window.testAuth = async function() {
      try {
        log('ðŸ” Testing authentication...', 'info');
        
        if (!auth) {
          log('âŒ Firebase Auth not initialized', 'error');
          return;
        }
        
        const userCredential = await signInAnonymously(auth);
        log(`âœ… Anonymous sign-in successful: ${userCredential.user.uid}`, 'success');
        
      } catch (error) {
        log(`âŒ Authentication failed: ${error.message}`, 'error');
      }
    };

    window.testFirestore = async function() {
      try {
        log('ðŸ—„ï¸ Testing Firestore connection...', 'info');
        
        if (!db) {
          log('âŒ Firestore not initialized', 'error');
          return;
        }
        
        if (!currentUser) {
          log('âš ï¸ No authenticated user, trying anonymous sign-in first...', 'warning');
          await testAuth();
          if (!currentUser) {
            log('âŒ Cannot test Firestore without authentication', 'error');
            return;
          }
        }
        
        // Test writing to Firestore
        const testDocRef = doc(db, 'test', 'connection-test');
        const testData = {
          message: 'Hello from Firebase test!',
          timestamp: serverTimestamp(),
          userUid: currentUser.uid
        };
        
        await setDoc(testDocRef, testData);
        log('âœ… Successfully wrote test document to Firestore', 'success');
        
        // Test reading from Firestore
        const docSnap = await getDoc(testDocRef);
        if (docSnap.exists()) {
          log('âœ… Successfully read test document from Firestore', 'success');
          log(`ðŸ“„ Document data: ${JSON.stringify(docSnap.data())}`, 'info');
        } else {
          log('âš ï¸ Test document not found', 'warning');
        }
        
        // Test querying collections that your app uses
        await testCollections();
        
      } catch (error) {
        log(`âŒ Firestore test failed: ${error.message}`, 'error');
        if (error.code) {
          log(`ðŸ” Error code: ${error.code}`, 'error');
        }
      }
    };

    async function testCollections() {
      const collections = ['vendors', 'users', 'attendees', 'leads'];
      
      for (const collectionName of collections) {
        try {
          const q = query(collection(db, collectionName));
          const querySnapshot = await getDocs(q);
          log(`ðŸ“Š ${collectionName} collection: ${querySnapshot.size} documents`, 'info');
        } catch (error) {
          log(`âš ï¸ Could not access ${collectionName} collection: ${error.message}`, 'warning');
        }
      }
    }

    window.testSecurityRules = async function() {
      try {
        log('ðŸ›¡ï¸ Testing Firestore security rules...', 'info');
        
        if (!db || !currentUser) {
          log('âŒ Need authenticated user and Firestore connection', 'error');
          return;
        }
        
        // Test reading vendors (should be allowed)
        try {
          const vendorsRef = collection(db, 'vendors');
          const vendorsSnapshot = await getDocs(vendorsRef);
          log(`âœ… Can read vendors collection (${vendorsSnapshot.size} docs)`, 'success');
        } catch (error) {
          log(`âš ï¸ Cannot read vendors: ${error.message}`, 'warning');
        }
        
        // Test creating a user document
        try {
          const userDocRef = doc(db, 'users', currentUser.uid);
          await setDoc(userDocRef, {
            createdAt: serverTimestamp(),
            uid: currentUser.uid,
            isAnonymous: currentUser.isAnonymous
          }, { merge: true });
          log('âœ… Can create/update user document', 'success');
        } catch (error) {
          log(`âš ï¸ Cannot create user document: ${error.message}`, 'warning');
        }
        
        // Test creating an attendee
        try {
          const attendeeRef = doc(db, 'attendees', `test-${Date.now()}`);
          await setDoc(attendeeRef, {
            name: 'Test Attendee',
            email: 'test@example.com',
            ownerUid: currentUser.uid,
            createdAt: serverTimestamp()
          });
          log('âœ… Can create attendee document', 'success');
        } catch (error) {
          log(`âš ï¸ Cannot create attendee: ${error.message}`, 'warning');
        }
        
      } catch (error) {
        log(`âŒ Security rules test failed: ${error.message}`, 'error');
      }
    };

    window.clearResults = function() {
      document.getElementById('results').innerHTML = '';
      document.getElementById('console').textContent = '';
    };

    // Initialize Firebase when page loads
    initializeFirebase().then(() => {
      log('ðŸš€ Firebase test page ready!', 'success');
    });
  </script>
</body>
</html>